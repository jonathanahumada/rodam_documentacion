

miércoles, 14 de julio de 2021, 16:57:37 -05
============================================

Ya me ha pasado en varias ocasiones que
el init de django corre todas las vistas
en urls.py

No la definición de la vista, sino que corre
de hecho el `solicitan_aprobacion_de_lecturas`

.. code-block:: python

   class MuestrasPorAprobacionFinal(ListView):
    """
    El QA ve solo las *muestras* remitidas por el microbiólogo.
    Debe hacer el control de calidad de los medios
    y dar el visto bueno final.
    """

    selector = MuestraSelector()
    queryset = selector.solicitan_aprobacion_de_lecturas()
    template_name = "calidad/muestras_para_QA.html"
    paginate_by = 10
    mensajes= None

como levanto una excepción, no deja que django
inicie. Ni siquiera para tests

.. code-block:: python

   def solicitan_aprobacion_de_lecturas(self):
        try:
            estado = self.traductor.get_estado("Solicita aprobación de lecturas")
            return self.object_manager.all().filter(estado= estado)
        except TraductorDeEstadoException:
            return self.none

me tocó gestionar esto así. No sé si me cause problemas
más tard


jueves, 15 de julio de 2021, 20:44:52 -05
============================================

Me doy cuenta que el comportamiento del inline form
de django no es igual dependiento de cuál elemento
escoga como padre del inline.

No sé si esto puede producir errores, pero
hoy me confundió bastante eso.

Entonces no se si dejar por funcionalidad:

.. code-block:: python

   class LecturaDeMuestra(LecturaGeneral):
    id_lectura = models.AutoField(primary_key= True)
    especificacion= models.ForeignKey('ingreso.Especificacion', on_delete=models.CASCADE, related_name="lectura_de_muestra")
    muestra = models.ForeignKey('ingreso.Muestra', on_delete=models.CASCADE, related_name="lecturas_de_muestra")
    lote_de_medio = models.ForeignKey('calidad.LoteDeMedio',on_delete=models.PROTECT, default=1)


pruebo manualmente que acceder a la lectura desde ambos related names sean equivalentes:

.. code-block:: python

		>>> especificacion2.lectura_de_muestra.all()
		<QuerySet [<Lectura(id='1', especificacion=' Dilución de ácido : entre 50 y 100 ufc')>, <Lectura(id='2', especificacion=' Dilución de ácido : entre 50 y 100 ufc')>]>

		>>> muestra1.lecturas_de_muestra.all()
		<QuerySet [<Lectura(id='1', especificacion=' Dilución de ácido : entre 50 y 100 ufc')>]>


Mon Jul 19 09:31:42 -05 2021
============================

¿Qué es lo más importante?

- que el formulario de especificaciones funcione completo

  - cambiar queryset de analisis

  la idea general es algo así.

  .. code-block:: python

   form.fields['utiliza'].queryset = utilizas

  - cambiar queryset de grupos:

  pero con los grupos es más complicado.

  debo hacer dos consultas.



Al final, esto parece funcionar. Aunque no he hecho pruebas:

.. code-block:: python

        for form in formset.forms:
            form.fields['utiliza'].queryset = utilizas
            form.fields['grupo'].queryset = grupos_relevantes


Ahora el problema está en el empty_form. Contaba con que se pudiera
manipular. Pero parece que no. Lo único en SO es esto:
https://stackoverflow.com/questions/14160436/change-the-queryset-in-a-empty-form

https://stackoverflow.com/questions/68186351/cannot-edit-fields-of-djangos-formets-empty-form-in-views

Veo solo 2 soluciones: 1) reemplazar el html con js o 2) configurar
el BaseInlineFormset.

Pero configurar el BaseInlineFormset no me pareció viable.
Este ejemplo de SO lo hace ver fácil (https://stackoverflow.com/questions/28201123/django-how-can-i-set-initial-values-to-formsets-empty-form/28734723#28734723).


.. code-block:: python

	class YourBaseInlineFormSet(forms.BaseInlineFormSet):
	    @property
	    def empty_form(self):  # This is almost the same as Django 3.1 code
	        form = self.form(
	            auto_id=self.auto_id,
	            prefix=self.add_prefix("__prefix__"),
	            empty_permitted=True,
	            use_required_attribute=False,
	            initial={"verification": self.initial_extra[0]["verification"]},  # This is the extra parameter
	            **self.get_form_kwargs(None),
	        )
	        self.add_fields(form, None)
	        return form


Pero si reviso el código fuente del `BaseInlineFormSet`no encuentro el `empty_form`.
No sé realmente qué es lo que hace. Además aquí solo le pasan datos al `initial`, pero
yo necesito modificar el queryset.

Estimo que es muy probable que el queryset solo se pueda manipular en el `__init__`.
Pero sin dominar el tema a fondo, eso puede causar problemas. No he visto en la documentación
que recomienden tocar el `__init__`


La solución final fue esta:

.. code-block:: python

	// en .click() de Añadir especificacion

	...

	// cambio las opciones disponibles para el dropdown
        utilizas_table_data = `#id_especificaciones-${form_index}-utiliza`
        grupo_tabla_data = `#id_especificaciones-${form_index}-grupo`
        $(utilizas_table_data).html(utilizas)
        $(grupo_tabla_data).html(grupos)


El papel de los compositores
============================
Básicamente, quiero aislar la lógica del formulario
de la lógica de la vista.


El API de un compositor, en principio, solo me ofrece GET y POST

.. code-block:: python


     LecturaDeMuestraInlineForm(request, id_muestra):
     	if request.method == "POST":
     	   form = compositor.POST(POST_data=request.POST)
     	   if form.is_valid():
     	       form.save()
     	       return redirect("recoleccion:gestionar_muestras")
     	else:
     	   compositor.generar_data_inicial(miembro_rodam=request.user.miembro_rodam)
     	   form = compositor.GET()


Tue Jul 20 10:22:37 -05 202
===========================

Resumen despliege:
- actualizar
- set host name
- crear usuario con privilegios reducidos
- crear llave RSA para SSH
- quitar la posibilidad de logearse al sistema con password
- configurar firewall (usar `ufw`)
- transferir el proyecto a VM
- cambiar `settings.py` para ambiente de producción
  ALLOWED_HOSTS
  STATIC
- instalar python3 y python3-(no legible) en ubuntu
- descargar apache con mod wsgi
- activar configuracioón con `a2ensite`, desactivar con `a2ensite`
- ocultar la información confidencial
  secret key
  `DEBUG false`
- revisar los permisos de unix para todo el path de la aplicación

anotaciones sobre el primer despliegue:
- hay que separar el viertualenv del proyecto Django e
  instalar el virtualenv usando el python del sistema

- en ubuntu se instala python3 y python3-virtualenv
  con el gestor de paquetes del sistema

- hay que reorganizar el static

- es preferible no poner el proyecto en un directorio de usuario
  donde los permisos están configuradaos para el. Apache necesita
  tener los acceso a todo el directorio.

- se requiere practicar más para entender la comunicación del protocolo
  wsgi

algo sobre la arquitectura
==========================
En general la responsabilidad de la vista es gestionar
peticiones http.

De esto naturalmente han emergido dos conceptos:

1) Compositors
   componen formularios. como estoy usando un framework
   es natural que 'dependa' (hace llamadas directas)
   de los formularios de Django. Sin embargo, esto
   está separado en alguna medida. Por ejemplo:

   .. code-block:: python

	EspecificacionCompositor(instance= adaptor.debeTener, form_class=EspecificacionForm, adaptor =adaptor)

   Aquí el formulario se separa del compositor como tal.
   Lo único 'impuro' es la llamada directa a una factory de Django.
   Pero eso simplemente se puede parametrizar

   Pero es necesario separar las respnsabilidades
   para que el código sea más comprensible y mucho más mantenibles.
   La práctica ha apoyado este precepto de la teoría. Me siento más
   seguro así.

2) Adaptors
   modelan casos de uso directamente de la lógica de negocios.
   En principio pensaba que un adaptador podía tener una
   relacion 1 a 1 con un modelo, pero ese pensamiento es
   limitante, y la práctica me dice que podría desmunuzar más cada adaptor.
   Aunque no es sabio desgastarse tanto por eso. En este momento
   las responsabilidades están suficientemente claras.


CBV vs FCV

Al fin y al cabo, tanto en la una como en la otra se puede:

.. code-block:: python

	if form.is_valid():
            object =  form.save(commit=False)
            object.registra_ingreso = request.user.miembro_rodam
            object.save()
            return redirect("ingreso:cuadroAnalitico_detalle", id_cuadroAnalitico=id_cuadroAnalitico)



En realidad lo único que está mal del formulario individual
es que es un inline form.

Wed Jul 21 11:25:21 -05 2021
============================
- hacer formulario [


- hay que desmenuzar esto:

::
   Django uses request and response objects to pass state through the system.



Detalles
--------

Como `generar_data_inicial` es un método del compositor, no tengo que verificar
que en el POST, se vuelva a pre-llenar el formulario. Solo tengo que probar
que llena un formulario.

.. code-block:: python

    def get(self, request,*args, **kwargs):
        data_inicial = self.compositor.generar_data_inicial(miembro_rodam=request.user.miembro_rodam, muestra=self.muestra)
        form = self.compositor.GET()


        return self.render_to_response(self.get_context_data(form=form))

    def post(self,request, *args, **kwargs):
        data_inicial = self.compositor.generar_data_inicial(miembro_rodam=request.user.miembro_rodam, muestra=self.muestra)
        form  = self.compositor.POST(POST_DATA=request.POST)

Nota. Esto *no* funcina porque

::

   These values (initial) are only displayed for unbound forms, and
   they’re not used as fallback values if a particular value isn’t
   provided.


Nota sobre las pruebas
----------------------
Pero aún así hay una ventaja y es que puedo simular una *bound form* sin tener
que lidiar con el test client.

Solo necesito simuar un `QueryDict` de un `Request`: https://docs.djangoproject.com/en/3.2/ref/request-response/#django.http.QueryDict


Problemas con la fecha
----------------------

resulta que el auto_now_add *no* guarda la fecha localizada, sino en UTC
.. code-block:: python

   class LecturaGeneral(models.Model):
        #puede existir sin resultado
        resultado_lectura = models.CharField(max_length=30)
        fecha_resultado_lectura = models.DateTimeField(blank=True, null=True, auto_now_add=True)


entonces, para leerlo bien, tocaría usar:

.. code-block:: python

	>>> from django.utils import timezone
	>>> timezone.localtime(lectura.fecha_resultado_lectura)
	datetime.datetime(2021, 7, 21, 14, 37, 36, 813625, tzinfo=<DstTzInfo 'America/Bogota' -05-1 day, 19:00:00 STD>)


Pero al parecer se puede en los templates directamente: https://stackoverflow.com/questions/42124050/timezone-aware-datetime-objects-in-django-templates



Tengo problemas con el bootstrap. No me está tomando el `table-dark`. En general no hay clases de la tabla

El medio del metodo
-------------------

El medio del método debe cambiar a 'Tipo de medio', para restringir más el formulario de lectura

Thu Jul 22 10:51:23 -05 2021
=============================

¿Qué se debe mostar en la sala de lecturas?
Un resumen del estado de lecturas.

- Para cada especificacion, debo poder enumerar sus lecturas DONE
- Saber rápidamente cuantas especificaciones faltan por lecturas DONE



Podría esto causar problemas?
-----------------------------

.. code-block:: python

	#primero genero la tabla
        adaptor.tabla_de_especificaciones
        especificaciones_completas =  adaptor.especificaciones_completas

        self.assertTrue(len(especificaciones_completas) == 1)
        self.assertEquals(especificaciones_completas[0], especificacion_de_la_lectura)

No puedo saber las especificaciones completas o pendientes si primero
no genero la tabla. Es lógico que funcione así.

Pero siendo hiperriguroso, un método público no debería tener una dependencia temporal


El dilema de abstraer
---------------------

No se si pasar esto:

.. code-block:: html

	<h1 id="titulo_detalle"> Muestra {{ object.lote_muestra }} de {{muestra.cuadroAnalitico.producto.nom_producto}} </h1>
	<h2 class="atributos_detalle"> Origen : {{ object.origen.nom_origen}} </h2>
	<h2 class="atributos_detalle"> Presentacion :  {{muestra.cuadroAnalitico.producto.forma_farmaceutica }} {{ object.presentacion}} </h2>
	<h2 class="atributos_detalle"> Lote: {{ object.lote_muestra }} </h2>
	<h2 class="atributos_detalle"> Tamaño : {{ object.tamano_muestra }} {{ object.unidades_tamano }} </h2>
	<h2 class="atributos_detalle"> Estado : {{ object.estado.nom }} </h2>


A un método del adaptor.

los adaptors y el refresh
-------------------------


tuve que poner esto en la sala de lecturas

.. code-block:: python

	def _cleanup(self):

	self.especificaciones_pendientes = []
        self.especificaciones_completas = []


Por alguna razón las especificaciones pendientes
se acumulaban cuando refrescaba la página.

Esto quiere decir que un nuevo adaptor no se crea
cuando refresco la vista. ¿Esto lo hace Django
automáticamente? Quien sabe.


Una solución más autocontenida es esta :


.. code-block:: python

    def _registrar_especificacion_pendiente(self, lecturas_hechas=None, especificacion=None):
      """Si no hay lecturas hechas, agrega la especificacion a las pendientes """
      especificaciones_pendientes = self.especificaciones_pendientes

      if len(lecturas_hechas) == 0 and especificacion not in especificaciones_pendientes:
            self.especificaciones_pendientes.append(especificacion)

    def _registrar_especificacion_completa(self, especificacion = None, lecturas_hechas=None):
       """Si una especificacion tiene lecturas hechas, llevamos una cuenta de las especificaciones
      completas"""

       especificaciones_completas = self.especificaciones_completas

       if len(lecturas_hechas) > 0 and especificacion not in especificaciones_completas :
          self.especificaciones_completas.append(especificacion)

Aquí evito duplicados.

Sin embargo, la idea de un _cleanup es buena. Porque lo tengo es algo parecido
al template pattern.


Pero *al final* tuve que poner el _cleanup. Cuando el


cerrar el dia
-------------
- no alcancé a probar la validación antes de remitir el lote
- queda pendiente lo de bootstrap. Parece que no está cargando bien.
- sospecho que hay clases que comparten estado de calidad y otras que no. Eso es confuso.
- el criterio de validación aún es difuso. toca discutirlo
- queda pendiente localizar la hora en la sala de lecturas
- me di cuenta de que el reporte de medios está mostrango el control de un mismo medio tantas veces como lecturas DONE

Fri Jul 23 10:42:55 -05 2021
==============================

- hoy lo primero es terminar la validación DONE
- luego, permmitir una edición básica DONE
- luego, la vista de aprobación final
- luego, arreglar el formulario de ingreso de cuadros analiticos



dudas de abstraccion
--------------------

Debería generar mensajes para mostrar en la validación?
.. code-block:: python

    def es_valida_para_solicitar_aprobacion_de_lecturas(self):
        es_valida= False
        self.tabla_de_especificaciones
        if len(self.especificaciones_pendientes) == 0: es_valida=True

        return es_valida


Terminé haciendolo. Hace todo más transparente

.. code-block:: python

    def _registrar_error_de_validacion(self, especificaciones_pendientes=None):
      string_de_especificaciones = "Las especificaciones con id's : {"
      for espec in especificaciones_pendientes:
          id = " {},".format(espec.id)
          string_de_especificaciones = string_de_especificaciones + id

      string_de_especificaciones += " }"

      msg = string_de_especificaciones + " tienen lecturas pendientes."

      self.errores_de_validacion.append(msg)




Residuos
--------

En inventario hay esto. Esta lectura es vieja

.. code-block:: python

	class Lectura(LecturaGeneral):
	...
	muestra = models.ForeignKey('ingreso.Muestra', on_delete=models.CASCADE, related_name="lecturas")


El 'related_name' se confunde con `lecturas_de_muestra`, que es el realmente funcional.

Hay que quitar esto, pero ahora estoy enfocado en otra cosa.


services/recoleccion/services  ya está demasiado grande. Toca separarlo

habrá variaciones que ahora mismo no ves

cerrar el dia
-------------
- no pude extender una modelform con campos que no pertenecen al modelo
- pero eso no es fundamental en este momento
- lo fundamental es ponder lo de emision
- y no olvidar mejorar la validación del login
- la funcionalidad se está acumulando y hay que ver cómo redirigir mejor.

Mon Jul 26 09:45:06 -05 2021
==============================
prioridades;
- la vista de aprobacion final DONE
- la vista da entender que es calidad, hay que cambiar eso DONE
- falta lo de localizar DONE

¿Debo hacer una sala de aprobacion?

No sé como llegó una muestra a emision sin tener lecturas. Es un misterio


Tue Jul 27 10:07:07 -05 2021
==============================

No se si debería volver esto su propia clase de adaptador.

Mezclo funcionalidad de dos adaptores.
- se cambí el inline form de ingresar cuadro analitico a formulario de creación

.. code-block:: python

	def get_context_data(self, **kwargs):
        	context = super().get_context_data(**kwargs)
        	self.id_muestra = self.kwargs['id_muestra']
        	adaptor = MuestraAdaptor(id_muestra=self.id_muestra, muestra_manager=Muestra.objects)
        	sala_de_lecturas = SalaDeLecturasAdaptor(id_muestra=self.id_muestra, muestra_manager=Muestra.objects)
        	context['tabla_de_especificacion'] = sala_de_lecturas.tabla_de_especificaciones
        	context["titulo_tabla"] = "lecturas"
        	context["encabezados"] = adaptor.encabezados_lecturas
        	context["tabla_generica"] = adaptor.tabla_de_lecturas
        	context["resumen"] = sala_de_lecturas.resumen
        	context["resumen"]["título"] = "Resumen de lecturas"
        	context["tabla_de_especificaciones"] = {'encabezados' :sala_de_lecturas.encabezados_especificaciones,
        	    'data': sala_de_lecturas.tabla_de_especificaciones,
        	    'titulo': 'Tabla de especificaciones'}



terminé mejorando la vista :


.. code-block:: python

	def get_context_data(self, **kwargs):
	        context = super().get_context_data(**kwargs)
	        self.id_muestra = self.kwargs['pk']
	        adaptor = SalaDeAprobacionAdaptor(id_muestra=self.id_muestra, muestra_manager=Muestra.objects)
	        context["resumen"] = adaptor.resumen
	        #la tabla generica presenta las lecturas
	        context["titulo_tabla"] = "lecturas"
	        context["encabezados"] = adaptor.encabezados_lecturas
	        context["tabla_generica"] = adaptor.tabla_de_lecturas

	        return context

En realidad lo unico que tengo que añadir son las especificaciones completas vs las totales


separé a django de mi código


.. code-block:: python

    @property
    def fecha_localizada(self):
        return timezone.localtime(self.fecha_resultado_lectura)


- creo que ya estoy listo para desplegar nuevamente
- checklist de despliege


Wed Jul 28 10:25:41 -05 2021
==============================

objetivos
---------
- usuario daniel
- borrar datos
- cuidarse de que no encuentre los tempates

el segundo despliege
--------------------
- duré como 45 minutos intentano arrancar
- el error era el mismo

- el `error.log` de apache era:

.. code-block:: sh

    [Wed Jul 28 10:18:19.147822 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302]   File "/home/jonatan/weblab-deploy/venv/lib/python3.8/site-packages/django/utils/log.py", line 75, in configure_logging
[Wed Jul 28 10:18:19.147824 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302]     logging_config_func(logging_settings)
[Wed Jul 28 10:18:19.147829 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302]   File "/usr/lib/python3.8/logging/config.py", line 808, in dictConfig
[Wed Jul 28 10:18:19.147831 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302]     dictConfigClass(config).configure()
[Wed Jul 28 10:18:19.147836 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302]   File "/usr/lib/python3.8/logging/config.py", line 570, in configure
[Wed Jul 28 10:18:19.147838 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302]     raise ValueError('Unable to configure handler '
[Wed Jul 28 10:18:19.147846 2021] [wsgi:error] [pid 563933:tid 140379357771520] [remote 186.80.52.63:28302] ValueError: Unable to configure handler 'file'


Esto pasa por que el componente logger no puede crear handers porque la ruta no existe o no tiene accesos

En el primer despliege pensé que lo había solucionado con permisos. Entonces:

.. code-block:: sh

	-rw-r--r--  1 jonatan www-data  519 Jun 20 03:00 CHANGELOG.txt
	-rw-r--r--  1 jonatan www-data  126 Jun 20 03:00 CHANGELOG.txt~
	drwxrwxr-x 17 jonatan www-data 4096 Jul 27 22:04 mysite
	-rw-r--r--  1 jonatan www-data  177 Jun 20 03:28 requirements.txt
	drwxrwxr-x  6 jonatan jonatan  4096 Jun 21 01:37 venv

Pero eso no estaba funcionando esta vez.

Una solución drástica fue modificar el `settings.py` para:


.. code-block:: python

	LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'DEBUG',
            'class': 'logging.FileHandler',
            'filename': '/home/jonatan/weblab-deploy/mysite/logs/debug.log',
        },
        'calidad_file':{
        'level': 'DEBUG',
        'formatter': 'basico',
        'class': 'logging.FileHandler',
        'filename': '/home/jonatan/weblab-deploy/mysite/logs/calidad.log'
        },
        'ingreso_file':{
        'level': 'DEBUG',
        'formatter': 'basico',
        'class': 'logging.FileHandler',
        'filename': '/home/jonatan/weblab-deploy/mysite/logs/ingreso.log'
        },
        'recoleccion_file': {
        'level': 'DEBUG',
        'formatter': 'basico',
        'class': 'logging.FileHandler',
        'filename': '/home/jonatan/weblab-deploy/mysite/logs/recoleccion.log'
      }
    },


Con el nombre completo sí sirve. Así que era cuestión de que el
directorio que se usaba no era el adecuado.  No sé por qué en mi
máquina /logs evalúa a jaumaf/logs, mientras que en ubuntu no.


Ahora, queda la duda de por qué en el primer despliege sí sirvó.

Ya. Había hecho esto y no me acordaba

.. code-block:: python

	            'filename': os.path.join(BASE_DIR,
        'logs/debug.log'), },





encontré un bug
---------------

El resumen tiene un comportamiento extraño
y seeguía sumando especificaciones

por ahora me tocó gestionarlo así:

.. code-block:: python

    @property
    def resumen(self):
        self._cleanup()
        self.tabla_de_especificaciones
        resumen = {
          'título': 'Resumen de Sala de Aprobación',
          'data' :{
          'id. muestra' :self.muestra.id,
          'núm. lote ': self.muestra.lote_muestra,
           'producto': self.muestra.cuadroAnalitico.producto.nom,
           'cliente' : self.muestra.cuadroAnalitico.producto.cliente,
           'origen' : self.muestra.origen.nom,
           'sector' : self.muestra.cuadroAnalitico.producto.sector.nom_sector,
          'especificaciones completas': len(self.especificaciones_completas),
          'especificaciones en cuadro' : len(self.especificaciones)
           }

        }
        return resumen



Esto  causaba esto `InvalidTemplateEngineError at /calidad/control/medio/MetodoDeControl/detalle/2'

- lo de collect static me jodío
- lo de pasar las acciones como un diccionario en el contexto no me sirvió bien


- en el nuevo
 STATIC_URL = '/static/'

STATIC_ROOT = os.path.join(BASE_DIR,'static_prod')

STATICFILES_DIRS = [
    BASE_DIR / "static",
]
APP_DIRS = True

- en el viejo

  STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR,'static_prod')
STATICFILES_DIRS = [
    BASE_DIR / "static",
]
APP_DIRS = True


momento de reflexión
---------------------
- qué hacer ahora
- qué tests faltan
- cómo consolido lo que ya está de la mejor manera?


- hay que cambiar el fulano nadies por algo progresivo
s [x]
- la lectura de control tambien hay que localizarla manualmente []

Thu Jul 29 11:48:27 -05 2021
===============================

- ahora hay que setear este enironment variable []

  .. code-block:: python

  self.directorio_salida = os.environ['WEBLAB']+"/tests/artefactos"


- algo causa que la hoja de calculos en mac no coga bien los separadores del csv. Pero no sé por qué



viernes, 30 de julio de 2021, 10:06:36 -05
===========================================

hoy:

- terminar con el test del reporter [x]
- explorar diferencia entre factories y stubs [x]
- disenar el pdf reporter [x]

vamos ...

la lectura de muestra pide un lote de medio. creo que eso aguanta para
un subfactory

Cuales son los pros/cons de usar factories y no stubs:
https://martinfowler.com/articles/mocksArentStubs.html#TheDifferenceBetweenMocksAndStubs


los stubs vs los mocks
=======================
Quedé más confundido luego de verificar la biblio.

Voy a usar el test completo, para que quede como si fuera
integracion


desenmarañando lo que hice
==========================

el main del report:

1. creo un doc template
2. creo una lista historia
3. creo la tabla del cliente
4. creo la tabla de la muestra
5. creo la tabla de resultados
6. creo espacio de parametros
7. creo notas al pie
8. creo disclaimer
9. espacio firma



lunes,  2 de agosto de 2021, 09:17:15 -05
========================================

- hay reunion
- ¿qué es lo más importante?

Para reunion
------------

- lecturas calidad/lecturas
- puntos de verificación explicita
- un lote de medio  necesitará historia de lecturas?

pasos a seguir
++++++++++++++


- backup de base de datos
- cómo accedera a consultas SQL
  - consultas preprogramadas
  - accesso por ssh
  - prueba por GC

- generación de certificado y espacio de clientes
- Módulo de trazabilidad
- Mejora de lecturas

- ¿Hago diagramas?


- creo que lo óptimo es hacer un objeto emisión
- que guarde un pdf para siempre

Dilema del pipe
-----------------------------


.. code-block:: python

    def _pipe(self, item):

        tabulizado = self._tabularizar(item) paragrafizado =
        self._envolver_en_parrafos(tabulizado) return paragrafizado


Es decir, primero tabulizo y luego paragrafizo


- al documento le faltan notas al pie


miércoles,  4 de agosto de 2021
===============================
- estoy enredandome con los tests del pdfreporter
- creo que tengo que separar:
  - mi builder básico
  - el formato rodam
  - el certificado
- y luego hacer un adapter especial para acomodar los datos

jueves,  5 de agosto de 2021
==============================
- necesito agilidad así que por ahora omitiré lo del formato
- en los reportes de la muestra no encuentor al cliente [ ]
- le hice un cambio al adaptor, revisar con los tests [ ]
- se me salió el corazón y era que habia importado el testcase de
  unittest y no de django.tests entonces estaba destruyendo mi base de
  datos []
- se me ocurrio de golpe poner la bandera de exportar en el metodo o
  incluso en el analisis

viernes,  6 de agosto de 2021
==============================

mar 10 ago 2021 08:36:23 -05
==============================
- Creo que diseñe el 'Lote de Medio Adaptor'
- creo que la lógica de producir tablas debe estar separada del
  adaptador
- Me falta el lote de la cepa en el resultado de lecturaDeControl []
- puedo poner las transformaciones que ncesito en los getters []
- tambien puedo hacer named tuples
- definitivamente es mala idea acoplar la sección del certificado al
  numero de elementos en el encabezado
- tiene que calcularse automáticamente


jue 12 ago 2021 09:52:26
==============================

- Para retornar pdf en response varia ligeramente
::
	import io
	from django.http import FileResponse
	from reportlab.pdfgen import canvas

	def some_view(request):
	    # Create a file-like buffer to receive PDF data.
	    buffer = io.BytesIO()

	    # Create the PDF object, using the buffer as its "file."
	    p = canvas.Canvas(buffer)

	    # Draw things on the PDF. Here's where the PDF generation
	    happens.  # See the ReportLab documentation for the full
	    list of functionality.  p.drawString(100, 100, "Hello
	    world.")

	    # Close the PDF object cleanly, and we're done.
	    p.showPage()
	    p.save()

	    # FileResponse sets the Content-Disposition header so that browsers
	    # present the option to save the file.
	    buffer.seek(0)
	    return FileResponse(buffer, as_attachment=True, filename='hello.pdf')

- el buffer es file-like
- al final hay un buffer.seek(0)
- El FileResponse setea el content disposition
- Encontré la respuesta. Tenía la clase bien :

::

   The required filename can be a string, the name of a file to
   receive the created PDF document; alternatively it can be an object
   which has a write method such as a BytesIO or file or socket.

En python es un poco difícil entender, al menos para mi. Esto es útil:
https://docs.python.org/3/library/io.html




::

   A concrete object belonging to any of these categories is called a
   file object. Other common terms are stream and file-like object.


Puedo imprimir el pdf, ahora me toca:

- logo [x]

  creo que no hay forma de auto-dimensionar el logo
  el ancho del logo es mas o menos ancho = 1.7 x altura

- identificador unico aleatorio []


- tengo que reemplazar los prints de los adaptadores por loggers, está creciendo la cosa []

- ver si para el csv también se puede un file response []
- hacer explicito que datos puedne pasarse a un modelo
  FormatoDocumento []


vie 13 ago 2021 10:28:45 -05
==============================

- Necesito determinar la mejor estrategia para guardar imagenes
- Lo primero es que recomiendan no guardar imagenes en la db

- esto lo dice:
https://softwareengineering.stackexchange.com/questions/264779/creating-a-separate-table-for-images-or-adding-image-fields-to-many-tables/275898#275898
::

   Storing images in the DB as BLOBS has never really been faster than
   the file system unless you have specialized hardware which you can
   tune at a very low level to optimize file IO (and there are few
   experts I've run across who really do this better than the
   thousands of engineers working on this problem at the OS / driver
   level).



 Y
 https://softwareengineering.stackexchange.com/questions/117893/how-to-add-image-support-to-client-server-database-application/117926#117926 


 ::

    Storing images in the database is not always a bad idea. If you
    have a small amount of images, say in the tens of thousands range,
    and they are small in size, sometimes the convenience of storing
    the images in the database outweighs the added complexity
    introduced by adding an additional storage server that needs to be
    written and supported into the mix



- consenso general parece ser usar file system
- Django tiene documentación sobre el uso del file system
- creo que es la opción más viable
- el beneficio es que está documentado y es escalable
- el costo es que tengo que aprender a usarlo
- estoy perdiendo el focus, creo que lo mejor es poner una firma manualmente,
  en caso de que necesite estar funcionando la pagina.

- Tengo una duda existencial entre

  - hash
  - pickling
  - encoding
  - random number

lun 16 ago 2021 19:42:25 -05
==============================

He estado buscando.

- hash

  lo más importante es que es one way.

  En este caso, sería bueno tener un registro único de un documento



 - pickling convierte un objeto en bytes. Parece que pythonr ecuerdo la definición del objeto.



1. hay un objeto Memorecord
2. hay un dbpickler
3. para hacerle un persistent id se sobreescribe el `persistent_id()`
4. ese método debe tener una signatura especifica
5.




mar 17 ago 2021
==================

- lo primero de hoy es el plan para formalizar emision
- lo mas sensato es hacer un diagrama



mié 18 ago 2021 12:13:55 -05
----------------------------

- pude configurar sendmail con un hotmail
- tener cuidado con la importacion del modulo. cambia el comportamiento
- los attachment no usan el wrapper sendmail, sino que toca la otra cosa.
-
vie 20 ago 2021 09:32:41 -05
==============================
- equipos en el adaptador de la muestra [x]


 lun 23 ago 2021 08:33:54
==============================

Lo que tiene más prioridad ahora es avanzar
antes que refinar el diseño.

Si ya está lo de los equipos, pasaré primero a

- el contador de páginas []
- cambiar las columnas []

Dependiendo de cómo me rinda, podré
refinar el adaptador para que  cambios
posteriores sean más fáciles


En términos de abstraccion, la cosa va así:

::

   DocTemplates --> PageTemplate  --> Frames  --> Flowables --> pdfgen.canvas



Bueno, hay una primer implementacion:

- aprovecho el build del simpleDocTemplate para ejecutar esto


.. code-block:: python

   def _anadir_numero_de_pagina(self, canvas):
        """
        El método más directo es usar el canvas.
        Si uso capas superiores, la configuración
        es más dispendiosa
        """
        pagina = canvas.getPageNumber()
        label = "pág. %(num_pag)s" % {"num_pag": pagina}
        canvas.drawString(10,10, label)
    

- pero si es un requerimiento del invima, seguramente necesita el
  total

- esta es una segunda aproximacion. Afortunadamente, estaba posteada
  en : https://code.activestate.com/recipes/576832/

  #+begin_src 
  class NumberedCanvas(canvas.Canvas):
    def __init__(self, *args, **kwargs):
        canvas.Canvas.__init__(self, *args, **kwargs)
        self._saved_page_states = []

    def showPage(self):
        self._saved_page_states.append(dict(self.__dict__))
        self._startPage()

    def save(self):
        """add page info to each page (page x of y)"""
        num_pages = len(self._saved_page_states)
        for state in self._saved_page_states:
            self.__dict__.update(state)
            self.draw_page_number(num_pages)
            canvas.Canvas.showPage(self)
        canvas.Canvas.save(self)

    def draw_page_number(self, page_count):
        self.setFont("Helvetica", 7)
        self.drawRightString(180*mm, 20*mm,
            "Pág. %d de %d" % (self._pageNumber, page_count))
  #+end_src

- aquí se modifica el canvas en uso y hace que registre cada página en
  un dict _saved_page_states. Esto sucede cuando se llama el showPage

- para darse una idea:


canvas.showPage()

#+begin_quote
The showPage method finishes the current page. All additional drawing
will be done on another page
#+end_quote


cambio de reuniones:
---------------------
1) el producto no redirige cuando se ingresa
2) nombres muy cortos
3)   0.00689
4) Descripcion del metodo más grande
en general las descripciones
5) botón de aprobar meterloal detalle
6) siempre aparecen tres metodsos
7) creo que el cuadro de control no se remite, sino que permite de una lecturas 8)  

cambios de reuniones
---------------------

1) fecha de inicio
2) quitar numero de analisis
3) en formulario de metodo es medio, no material
4)   que aparezca el responsable de la lectura en seccion microbiologo
5)   poner un campo string en la lectura de control
6)   no va "muestreado por"
7) cambiar "metodo de muestreo" por "origen"

mar 24 ago 2021 10:18:44
=========================

- los equipos deberian swer

  ::

     (equipo1, equipo,2, equipo3)

  o

  ::

     ((equipo1), (equipo2),(equipo3))

- bueno eso lo resolvi. era obvio

- lo del hash si es jodido


 mié 25 ago 2021 11:28:49 -05
==============================

para cambiarlo luego.


.. code-block::

   //services.py

   medio_del_metodo =parte_de_especificacion.material_de_control


   
- las tablas de lectura y de especificacion ya funcionan con namedtuples [x]
- hay que deshacer la dependencia temporal entre las tablas y los registros [x]

jue 26 ago 2021 11:15:13 -05
==============================

Estoy inconforme con esto.

Hay cosas que se comṕutan dos veces por la naturaleza del procedimiento.
No siempre se computan las lecturas hechas entonces eso es un computo agregado
en la clase hijo.


  
.. code-block:: bash



	2021-08-26 11:08:30,312 services Se instanció un MuestraAdaptor
	2021-08-26 11:08:30,323 services inicia construcción de tabla de especificacion para <Muestra(id='5', lote='4444')>
	2021-08-26 11:08:30,330 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,330 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,332 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='9',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,337 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,337 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,337 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='10',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Siembra e incubación para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,343 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,343 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,343 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='11',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento + peptona para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,348 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,348 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,348 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='12',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya')>
	2021-08-26 11:08:30,352 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,352 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,352 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='13',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 5 mi para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya mas')>
	2021-08-26 11:08:30,356 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,356 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,356 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='14',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 30 m para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya aun mas')>
	2021-08-26 11:08:30,361 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,361 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,361 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='15',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 45 m para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya resto')>
	2021-08-26 11:08:30,368 sala_de_lecturas inicia _filtrarFilaTablaEspecificacion
	2021-08-26 11:08:30,368 sala_de_lecturas inicia _procesar_especificacion_en_fila
	2021-08-26 11:08:30,368 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='16',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento + peptona para  Actividad bactericida básica',mat_de_control='Staphiloccocus Aureus', valor='una mas para estar seguros')>
	2021-08-26 11:08:30,369 services termina construcción de tabla de especificacion para <Muestra(id='5', lote='4444')>
	2021-08-26 11:08:30,369 services inicia construcción de tabla de lecturas para <Muestra(id='5', lote='4444')>
	2021-08-26 11:08:30,474 services termina construcción de tabla de lecturas para <Muestra(id='5', lote='4444')>
	2021-08-26 11:08:30,474 sala_de_lecturas inicia resumen de SalaDeLecturas
	2021-08-26 11:08:30,478 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='9',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,482 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='10',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Siembra e incubación para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,485 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='11',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento + peptona para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,488 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='12',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya')>
	2021-08-26 11:08:30,492 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='13',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 5 mi para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya mas')>
	2021-08-26 11:08:30,497 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='14',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 30 m para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya aun mas')>
	2021-08-26 11:08:30,500 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='15',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 45 m para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya resto')>
	2021-08-26 11:08:30,504 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='16',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento + peptona para  Actividad bactericida básica',mat_de_control='Staphiloccocus Aureus', valor='una mas para estar seguros')>
	2021-08-26 11:08:30,508 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='9',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,512 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='10',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Siembra e incubación para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,516 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='11',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento + peptona para  Actividad bactericida básica',mat_de_control='Bacillus subtilis spizizenii', valor='entre 50 y 100 ufc')>
	2021-08-26 11:08:30,519 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='12',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya')>
	2021-08-26 11:08:30,523 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='13',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 5 mi para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya mas')>
	2021-08-26 11:08:30,527 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='14',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 30 m para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya aun mas')>
	2021-08-26 11:08:30,531 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='15',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Dilución - neutralización 45 m para  Actividad bactericida básica',mat_de_control='No Aplica', valor='que diluya resto')>

		2021-08-26 11:08:30,535 sala_de_lecturas inicia_lecturas_segun_especificacion_en_muestrapara <Especificacion<id='16',debe_tener='Análisis en Cuadro complejo para Natrumax  ', utiliza='Enriquecimiento + peptona para  Actividad bactericida básica',mat_de_control='Staphiloccocus Aureus', valor='una mas para estar seguros')>
	

Pero debo avanzar.Ahora con la sala de aprobaciones


vie 27 ago 2021 08:45:05 -05
=============================



listo. los adaptadores estan serviendo.
Antes de avanzar. quiero hacer un diagnostico general.

- he perdido demasiado tiempo porque el test discovery no me está sirviendo

- si corro


::

   (venv) (base) [jaumaf@Sypha mysite]$ python manage.py test tests
   System check identified no issues (0 silenced).
   E
   ======================================================================
   ERROR: mysite.tests (unittest.loader._FailedTest)
   ----------------------------------------------------------------------
   ImportError: Failed to import test module: mysite.tests
   Traceback (most recent call last):
     File "/home/jaumaf/miniconda3/lib/python3.9/unittest/loader.py", line 470, in _find_test_path
       package = self._get_module_from_name(name)
     File "/home/jaumaf/miniconda3/lib/python3.9/unittest/loader.py", line 377, in _get_module_from_name
       __import__(name)
   ModuleNotFoundError: No module named 'mysite.tests'
   
   
   ----------------------------------------------------------------------
   Ran 1 test in 0.000s



- esta buscando un modulo, no un paquete
- no se en qué momento esto cambio de comportamineto ni por que

- encontré un fix al problema:



 ::


    (venv) (base) [jaumaf@Sypha mysite]$ python ./manage.py test tests -t ./
    Creating test database for alias 'default'...
    System check identified no issues (0 silenced).
    ..........................s...s....................................................s.s.........................
    ----------------------------------------------------------------------
    Ran 111 tests in 20.727s


- no sé por qué ahora tengo que especificar el top level. En el mac no lo detectaba enseguida


mar 31 ago 2021 15:26:10 -05
==============================

- modelo de formato [x]
- subida de firmas [x]



realmente aún no entiendo esto:

::

   Although you might think about storing files in the database,

   consider that it is bad design in 99% of the cases. This field is
   not a replacement for proper static files handling.




   "Carrera 50 Bis # 44 A 32. Tel. 7 32 54 45 CEL: 3046169202-3003085783\n Bogotá - Colombia E-mail: rodam.analisis@gmail.com"]


¿Dónde guardo variables que deben ser visibles para la aplicación, pero que puedan cambiar en tiempo de ejecucion?

- https://stackoverflow.com/questions/5774783/how-to-keep-django-app-settings-in-database-or-change-on-the-fly


Lo he estado revisando y creo que la solución será esta ContentTypes

::
   
    Using these methods, you can write high-level generic code that performs queries on any installed model – instead of importing and using a single specific model class, you can pass an app_label and model into a ContentType lookup at runtime, and then work with the model class or retrieve objects from it.
    You can relate another model to ContentType as a way of tying instances of it to particular model classes, and use these methods to get access to those model classes.


mié 01 sep 2021 14:38:57 -05
==============================
- listo. creare una clase de configuracion

  ingreso_debetener.cuadroAnalitico_id

      raise IntegrityError(
django.db.utils.IntegrityError: The row in table 'ingreso_debetener' with primary key '1' has an invalid foreign key: ingreso_debetener.cuadroAnalitico_id contains a value '1' that does not have a corresponding value in ingreso_cuadroanalitico.id_cuadroAnalitico



- básicamente, el flujo es el siguiente:


      raise IntegrityError(
django.db.utils.IntegrityError: The row in table 'ingreso_debetener' with primary key '1' has an invalid foreign key: ingreso_debetener.cuadroAnalitico_id contains a value '1' that does not have a corresponding value in ingreso_cuadroanalitico.id_cuadroAnalitico



- básicamente, el flujo es el siguiente:

.. code-block:: python
		
	>>> from django.contrib.contenttypes.models import ContentType
	>>> from base.models import WeblabConf
	>>> cnf = WeblabConf.objects.get(tag="certificado_vigente)
	  File "<console>", line 1
	    cnf = WeblabConf.objects.get(tag="certificado_vigente)
	                                                          ^
	SyntaxError: EOL while scanning string literal
	>>> cnf = WeblabConf.objects.get(tag="certificado_vigente")
	>>> cnf
	<WeblabConf: certificado_vigente>
	>>> cnf.object_id
	1
	>>> cnf.content_object
	<FormatoCertificado id='1' nom= 'FO 022'>
	>>> from emision.models import FormatoCertificado
	>>> formato_pruebo = FormatoCertificado.objects.get(pk=2)
	>>> formato_pruebo
	<FormatoCertificado id='2' nom= 'PR01'>
	>>> cnf
	<WeblabConf: certificado_vigente>
	>>> cnf.content_object = formato_pruebo
	>>> cnf.content_object
	<FormatoCertificado id='2' nom= 'PR01'>
	>>> cnf.object_id
	2
	>>> cnf.save()
	
